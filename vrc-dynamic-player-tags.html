<!DOCTYPE html>
<html lang="en">
<head>
  <script defer src="https://analytics.baloneys.studio/script.js" data-website-id="03418d76-12f0-4a2b-94ba-24dff73a6f6b"></script>
  <meta charset="utf-8" />
  <title>VRCDynamicPlayerTags</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- RESET & BASE -->
  <style data-tag="reset-style-sheet">
    html { line-height: 1.15; }
    body { margin: 0; }
    * { box-sizing: border-box; -webkit-font-smoothing: antialiased; }
    a { text-decoration: none; color: inherit; }
  </style>

  <style data-tag="default-style-sheet">
    html { font-family: Inter, sans-serif; font-size: 1rem; }
    body { line-height: 1.6; background: var(--color-surface); color: var(--color-on-surface); }
  </style>

  <!-- CORE STYLE -->
  <link rel="stylesheet" href="./style.css" />

  <!-- PAGE STYLE -->
  <link rel="stylesheet" href="./vrc-dynamic-player-tags.css" />

  <!-- FONTS -->
  <link rel="stylesheet"
    href="https://fonts.googleapis.com/css2?family=Inter:ital,wght@0,100;0,200;0,300;0,400;0,500;0,600;0,700;0,800;0,900&display=swap" />
</head>

<body>

  <!-- HEADER WITH SUBMISSION BUTTON -->
  <header class="header-section" style="display:flex;justify-content:space-between;align-items:center;">
    <div class="header-container">
      <div class="header-content">
        <h1 class="header-title hero-title">VRCDynamicPlayerTags</h1>
      </div>
    </div>
    <div style="margin-right:24px;">
      <button id="gotoSubmissions" class="btn btn-primary btn-lg">
        New Submission
      </button>
    </div>
  </header>

  <!-- SEARCH BAR -->
  <section class="search-bar-section">
    <div class="search-bar-container" style="max-width:700px;margin:auto;">
      <div class="search-bar-card" style="padding:1.5rem;">
        <div class="search-bar-header">
          <h2 class="section-title">Explore Presets</h2>
          <p class="section-content">Search by exact Code, Target System, or Description.</p>
        </div>
        <div class="search-bar-form-wrapper">
          <div class="search-bar-input-group" style="max-width:400px;margin:auto;">
            <input type="text" id="searchInput" class="search-bar-input"
              placeholder="Exact match search..." style="font-size:1rem;padding:0.7rem;" />
          </div>
          <div class="search-bar-filter-chips" style="margin-top:1rem;display:flex;gap:0.5rem;justify-content:center;">
            <button type="button" class="search-bar-chip active" data-mode="code">Code</button>
            <button type="button" class="search-bar-chip" data-mode="targetSystem">Target System</button>
            <button type="button" class="search-bar-chip" data-mode="description">Description</button>
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- TABLE (3 COLUMNS) -->
  <section class="dashboard-section">
    <div class="vrcdynamicplayertags-dashboard-container">
      <div class="dashboard-table-wrapper">
        <table class="vrcdynamicplayertags-dashboard-table">
          <thead>
            <tr>
              <th>Code</th>
              <th>Target System</th>
              <th>Description</th>
            </tr>
          </thead>
          <tbody id="tableBody"></tbody>
        </table>
      </div>
    </div>
  </section>

  <!-- ACTION BUTTONS & PAGINATION -->
  <section class="cta-actions-section">
    <div class="cta-actions-container"
      style="display:flex;justify-content:center;gap:1rem;flex-wrap:wrap;padding:1rem 0;">
      <button id="refreshBtn" class="action-card">Refresh Code List</button>
      <button id="importBtn" class="action-card">Import JSON</button>
      <button id="validateBtn" class="action-card">Validate Codes</button>
    </div>
    <div style="text-align:center;margin-top:1rem;">
      <button id="prevBtn" class="btn btn-secondary">Prev</button>
      <span id="pageIndicator"></span>
      <button id="nextBtn" class="btn btn-secondary">Next</button>
    </div>
  </section>

  <!-- DEBUG CONSOLE -->
  <section style="margin:1rem auto; max-width:700px;">
    <pre id="debugConsole" style="background:#111;color:#0f0;padding:1rem;overflow:auto;height:150px;"></pre>
  </section>

  <script>
  document.addEventListener("DOMContentLoaded", () => {

    const INDEX_JSON_URL = "./presets/index.json";
    const PAGE_SIZE = 5;

    let allPresets = [];
    let filtered = [];
    let currentPage = 0;
    let searchMode = "code";

    const tableBody = document.getElementById("tableBody");
    const searchInput = document.getElementById("searchInput");
    const pageIndicator = document.getElementById("pageIndicator");
    const chips = document.querySelectorAll(".search-bar-chip");
    const debugConsole = document.getElementById("debugConsole");

    function logDebug(msg) {
      if(debugConsole) debugConsole.textContent += msg + "\n";
    }

    async function loadIndex() {
      allPresets = [];
      try {
        logDebug("Fetching index.json...");
        const res = await fetch(INDEX_JSON_URL + "?_=" + new Date().getTime()); // cache-buster
        if(!res.ok) throw new Error(`HTTP ${res.status}`);
        const data = await res.json();
        logDebug(`Loaded ${data.presets.length} presets from index.json`);
        allPresets = data.presets;
      } catch(err) {
        logDebug("Failed to load index.json: " + err);
      }

      filtered = [...allPresets];
      currentPage = 0;
      renderTable();
    }

    function renderTable() {
      tableBody.innerHTML = "";
      const start = currentPage * PAGE_SIZE;
      const items = filtered.slice(start, start + PAGE_SIZE);

      items.forEach(p => {
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td><code>${p.code}</code></td>
          <td>${p.targetSystem || ""}</td>
          <td>${p.description || ""}</td>
        `;
        tableBody.appendChild(tr);
      });

      pageIndicator.textContent =
        `Page ${currentPage + 1} of ${Math.max(1, Math.ceil(filtered.length / PAGE_SIZE))}`;
    }

    function applySearch() {
      const q = searchInput.value.trim().toLowerCase();
      if(!q) {
        filtered = [...allPresets];
      } else {
        filtered = allPresets.filter(p => (p[searchMode] || "").toLowerCase() === q);
      }
      currentPage = 0;
      renderTable();
    }

    searchInput.addEventListener("input", applySearch);
    chips.forEach(c => {
      c.addEventListener("click", () => {
        chips.forEach(b => b.classList.remove("active"));
        c.classList.add("active");
        searchMode = c.dataset.mode;
        applySearch();
      });
    });

    document.getElementById("prevBtn").addEventListener("click", () => {
      if(currentPage > 0) { currentPage--; renderTable(); }
    });

    document.getElementById("nextBtn").addEventListener("click", () => {
      if((currentPage + 1) * PAGE_SIZE < filtered.length) { currentPage++; renderTable(); }
    });

    document.getElementById("refreshBtn").addEventListener("click", loadIndex);

    document.getElementById("importBtn").addEventListener("click", async () => {
      try {
        logDebug("Import JSON clicked...");
        const input = document.createElement("input");
        input.type = "file";
        input.accept = ".json";
        input.onchange = async e => {
          const file = e.target.files[0];
          const text = await file.text();
          const json = JSON.parse(text);
          if(!json.code || !json.targetSystem || !json.description) throw new Error("Invalid JSON");
          logDebug(`Imported preset ${json.code}`);
          
          // POST to backend to save preset and update index.json
          const res = await fetch("/submit", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(json)
          });
          const result = await res.json();
          if(result.success) {
            logDebug(`Preset ${result.code} saved to GitHub.`);
            loadIndex();
          } else {
            logDebug(`Failed to save preset: ${result.error}`);
          }
        };
        input.click();
      } catch(err) {
        logDebug("Import failed: " + err);
      }
    });

    document.getElementById("validateBtn").addEventListener("click", async () => {
      logDebug("Validate codes clicked...");
      try {
        // Trigger redeploy by updating index.json (force push)
        const res = await fetch("/validate", { method: "POST" });
        const result = await res.json();
        if(result.success) logDebug("Deployment triggered successfully.");
        else logDebug("Deployment failed: " + result.error);
      } catch(err) {
        logDebug("Deployment error: " + err);
      }
    });

    document.getElementById("gotoSubmissions").addEventListener("click", () => {
      window.location.href = "submissions.html";
    });

    // initial load
    loadIndex();

  });
  </script>

</body>
</html>
