<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>VRCDynamicPlayerTags</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- RESET & BASE -->
  <style data-tag="reset-style-sheet">
    html { line-height: 1.15; }
    body { margin: 0; }
    * { box-sizing: border-box; -webkit-font-smoothing: antialiased; }
    a { text-decoration: none; color: inherit; }
  </style>

  <style data-tag="default-style-sheet">
    html { font-family: Inter, sans-serif; font-size: 1rem; }
    body { line-height: 1.6; background: var(--color-surface); color: var(--color-on-surface); }
  </style>

  <!-- CORE STYLE -->
  <link rel="stylesheet" href="./style.css" />

  <!-- PAGE STYLE -->
  <link rel="stylesheet" href="./vrc-dynamic-player-tags.css" />

  <!-- FONTS -->
  <link rel="stylesheet"
    href="https://fonts.googleapis.com/css2?family=Inter:ital,wght@0,100;0,200;0,300;0,400;0,500;0,600;0,700;0,800;0,900&display=swap" />
</head>

<body>

  <!-- HEADER WITH SUBMISSION BUTTON -->
  <header class="header-section" style="display:flex;justify-content:space-between;align-items:center;">
    <div class="header-container">
      <div class="header-content">
        <h1 class="header-title hero-title">VRCDynamicPlayerTags</h1>
      </div>
    </div>
    <div style="margin-right:24px;">
      <button id="gotoSubmissions" class="btn btn-primary btn-lg">
        New Submission
      </button>
    </div>
  </header>

  <!-- SEARCH BAR -->
  <section class="search-bar-section">
    <div class="search-bar-container" style="max-width:700px;margin:auto;">
      <div class="search-bar-card" style="padding:1.5rem;">
        <div class="search-bar-header">
          <h2 class="section-title">Explore Presets</h2>
          <p class="section-content">Search by exact Code, Target System, or Description.</p>
        </div>

        <div class="search-bar-form-wrapper">
          <div class="search-bar-input-group" style="max-width:400px;margin:auto;">
            <input type="text" id="searchInput" class="search-bar-input"
              placeholder="Exact match search..." style="font-size:1rem;padding:0.7rem;" />
          </div>

          <div class="search-bar-filter-chips" style="margin-top:1rem;display:flex;gap:0.5rem;justify-content:center;">
            <button type="button" class="search-bar-chip active" data-mode="code">Code</button>
            <button type="button" class="search-bar-chip" data-mode="targetSystem">Target System</button>
            <button type="button" class="search-bar-chip" data-mode="description">Description</button>
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- TABLE (3 COLUMNS) -->
  <section class="dashboard-section">
    <div class="vrcdynamicplayertags-dashboard-container">
      <div class="dashboard-table-wrapper">
        <table class="vrcdynamicplayertags-dashboard-table">
          <thead>
            <tr>
              <th>Code</th>
              <th>Target System</th>
              <th>Description</th>
            </tr>
          </thead>
          <tbody id="tableBody"></tbody>
        </table>
      </div>
    </div>
  </section>

  <!-- ACTION BUTTONS & PAGINATION -->
  <section class="cta-actions-section">
    <div class="cta-actions-container"
      style="display:flex;justify-content:center;gap:1rem;flex-wrap:wrap;padding:1rem 0;">
      <button id="refreshBtn" class="action-card">Refresh Code List</button>
      <button id="importBtn" class="action-card">Import JSON</button>
      <button id="validateBtn" class="action-card">Validate Codes</button>
    </div>
    <div style="text-align:center;margin-top:1rem;">
      <button id="prevBtn" class="btn btn-secondary">Prev</button>
      <span id="pageIndicator"></span>
      <button id="nextBtn" class="btn btn-secondary">Next</button>
    </div>
  </section>

  <!-- DEBUG CONSOLE -->
  <section style="margin:1rem auto; max-width:700px;">
    <pre id="debugConsole" style="background:#111;color:#0f0;padding:1rem;overflow:auto;height:150px;"></pre>
  </section>

  <script>
    document.addEventListener("DOMContentLoaded", () => {

      const PRESETS_API = "https://dynabackend-h8jf.onrender.com/presets/";
      const PAGE_SIZE = 5;

      let allPresets = [];
      let filtered = [];
      let currentPage = 0;
      let searchMode = "code";

      const tableBody = document.getElementById("tableBody");
      const searchInput = document.getElementById("searchInput");
      const pageIndicator = document.getElementById("pageIndicator");
      const chips = document.querySelectorAll(".search-bar-chip");
      const debugConsole = document.getElementById("debugConsole");

      function logDebug(msg) {
        if(debugConsole) debugConsole.textContent += msg + "\n";
      }

      async function loadPresets() {
        allPresets = [];
        logDebug("Loading index.json from server...");
        try {
          const indexRes = await fetch(PRESETS_API + "index.json");
          const indexData = await indexRes.json();
          logDebug(`Found ${indexData.presets.length} presets.`);

          for (const code of indexData.presets) {
            try {
              const presetData = await fetch(PRESETS_API + code + ".json").then(r => r.json());
              allPresets.push(presetData);
              logDebug(`Loaded preset ${code}`);
            } catch(err) {
              logDebug(`Failed to load preset ${code}: ${err}`);
            }
          }
        } catch(err) {
          logDebug("Failed to load index.json: " + err);
        }

        filtered = [...allPresets];
        currentPage = 0;
        render();
      }

      function render() {
        tableBody.innerHTML = "";
        const start = currentPage * PAGE_SIZE;
        const items = filtered.slice(start, start + PAGE_SIZE);

        items.forEach(p => {
          const tr = document.createElement("tr");
          tr.innerHTML = `
            <td><code>${p.code}</code></td>
            <td>${p.targetSystem || ""}</td>
            <td>${p.description || ""}</td>
          `;
          tableBody.appendChild(tr);
        });

        pageIndicator.textContent =
          `Page ${currentPage + 1} of ${Math.max(1, Math.ceil(filtered.length / PAGE_SIZE))}`;
      }

      function applySearch() {
        const q = searchInput.value.trim().toLowerCase();

        if (!q) {
          filtered = [...allPresets];
        } else {
          filtered = allPresets.filter(p => {
            const value = (p[searchMode] || "").toLowerCase();
            return value === q; // exact match
          });
        }
        currentPage = 0;
        render();
      }

      searchInput.addEventListener("input", applySearch);

      chips.forEach(c => {
        c.addEventListener("click", () => {
          chips.forEach(
