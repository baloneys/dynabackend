<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>VRCDynamicPlayerTags - Submissions</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- RESET & BASE -->
  <style data-tag="reset-style-sheet">
    html { line-height: 1.15; }
    body { margin: 0; }
    * { box-sizing: border-box; -webkit-font-smoothing: antialiased; }
    a { text-decoration: none; color: inherit; }
  </style>

  <style data-tag="default-style-sheet">
    html { font-family: Inter, sans-serif; font-size: 1rem; }
    body { line-height: 1.6; background: var(--color-surface); color: var(--color-on-surface); }
    input, textarea { font-family: Inter, sans-serif; font-size: 1rem; }
  </style>

  <!-- CORE STYLE -->
  <link rel="stylesheet" href="./style.css" />

  <!-- PAGE STYLE -->
  <link rel="stylesheet" href="./submissions.css" />

  <!-- FONTS -->
  <link rel="stylesheet"
    href="https://fonts.googleapis.com/css2?family=Inter:ital,wght@0,100;0,200;0,300;0,400;0,500;0,600;0,700;0,800;0,900&display=swap" />
</head>

<body>

  <header class="header-section" style="display:flex;justify-content:center;align-items:center;margin-bottom:2rem;">
    <h1 class="header-title hero-title">Submit a New Preset</h1>
  </header>

  <section class="submission-form-section" style="max-width:700px;margin:auto;">
    <div class="submission-card" style="padding:2rem;background:#f4f4f4;border-radius:8px;box-shadow:0 2px 8px rgba(0,0,0,0.1);">
      <label for="targetSystem">Target System</label>
      <input type="text" id="targetSystem" placeholder="Enter target system" style="width:100%;padding:0.5rem;margin-bottom:0.5rem;" />

      <label for="description">Description</label>
      <textarea id="description" rows="3" placeholder="Enter description" style="width:100%;padding:0.5rem;margin-bottom:0.5rem;"></textarea>

      <label for="knownTMPs">Known TMPs</label>
      <textarea id="knownTMPs" rows="2" placeholder="Comma-separated TMP names" style="width:100%;padding:0.5rem;margin-bottom:0.2rem;"></textarea>
      <small>Populate with TMP names separated by commas</small>

      <label for="knownTriggers">Known Triggers</label>
      <textarea id="knownTriggers" rows="2" placeholder="Comma-separated trigger names" style="width:100%;padding:0.5rem;margin-bottom:0.2rem;"></textarea>
      <small>Populate with trigger names separated by commas</small>

      <button id="submitBtn" style="margin-top:1rem;padding:0.75rem 1.5rem;">Submit Preset</button>
    </div>
  </section>

  <section style="margin:1rem auto; max-width:700px;">
    <pre id="debugConsole" style="background:#111;color:#0f0;padding:1rem;overflow:auto;height:150px;"></pre>
  </section>

  <script>
    document.addEventListener("DOMContentLoaded", () => {
      const submitBtn = document.getElementById("submitBtn");
      const debugConsole = document.getElementById("debugConsole");

      function logDebug(msg) {
        if(debugConsole) debugConsole.textContent += msg + "\n";
      }

      async function submitPreset() {
        const targetSystem = document.getElementById("targetSystem").value.trim();
        const description = document.getElementById("description").value.trim();
        const knownTMPs = document.getElementById("knownTMPs").value.split(",").map(s => s.trim()).filter(Boolean);
        const knownTriggers = document.getElementById("knownTriggers").value.split(",").map(s => s.trim()).filter(Boolean);

        if (!targetSystem || !description) {
          alert("Target System and Description are required");
          return;
        }

        const code = Math.floor(100000 + Math.random() * 900000).toString();
        logDebug(`→ Submitting preset ${code}...`);

        const preset = { code, targetSystem, description, KnownTMPs: knownTMPs, KnownTriggers: knownTriggers };

        try {
          // Save individual JSON file
          await fetch(`/presets/${code}.json`, {
            method: "PUT",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(preset, null, 2)
          });

          logDebug(`✔ Preset ${code}.json saved.`);

          // Update index.json
          const indexRes = await fetch(`/presets/index.json`);
          let indexData = { presets: [] };

          try {
            indexData = await indexRes.json();
          } catch(e) {
            logDebug("Index file not found, creating new one...");
          }

          indexData.presets.push({ code, targetSystem, description });

          await fetch(`/presets/index.json`, {
            method: "PUT",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(indexData, null, 2)
          });

          logDebug(`✔ index.json updated with ${code}`);

          alert(`Preset ${code} submitted successfully!`);
          window.location.href = "vrc-dynamic-player-tags.html";

        } catch (err) {
          logDebug(`❌ Submission failed: ${err}`);
          alert("Submission failed. Check console.");
        }
      }

      submitBtn.addEventListener("click", submitPreset);
    });
  </script>

</body>
</html>
